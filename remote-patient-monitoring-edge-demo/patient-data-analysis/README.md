# Analysis Engine

This is a Node Express application that handles incoming FHIR-formatted patient vital data and analyzes it for troubling conditions. It produces a simple green/yellow/red analysis against set thresholds as well as producing FHIR flags in cases of extreme weight gain (a key indicator of a critical congestive heart failure patient). 

## Data Prerequisites for Deployment

- **FHIR Server URL**
  - The analysis container uses the FHIR server to GET and POST vital data. The FHIR URL should be set by Helm or by .env.development when running locally.

## How Analysis Works

Data generated by the Data Generator command line tool (TODO: link to repo) or the Bluetooth Mobile App (TODO: link to repo) will be submitted in a preliminary status when it is inserted into the FHIR database. This analysis engine application will query the FHIR server (TODO: link to repo) for all preliminary vitals on a set interval (default is every 5 seconds), then analyze those vitals to measure their status against set thresholds (green is healthy, yellow is slightly high or low, red is very high or low). This data is then submitted as finalized to FHIR and will show up on the React frontend application (TODO: link to repo).

### Weight Analysis

Weight measurements are handled as a special case of vital and are analyzed as a trend over time. Each weight measurement is assessed against the previous days' weights. More than 2 lbs. weight gain over 24 hours (1 day) or more than 4 lbs. weight gain over 168 hours (7 days) is considered a red status (unhealthy), while all other conditions are considered a green status (healthy). The same red analysis condition writes a flag or 'triggering event' to FHIR to indicate to a clinician that patient requires attention. This 'bubbles the patient to the top' as a more noteworthy and prominent record and will also produce an in-app notification on the frontend application.

## Deploy via Helm

The **recommended** approach is to deploy all containers at once with the Helm chart in the parent directory. (see [README](./../README.md#get-started))

But, if you want to deploy this single container you can do so by setting the empty values in [`values.helm`](./helm/values.yaml) and then running

``` bash
helm upgrade --install analysis helm
```


# Developer Notes

The analysis container can be run locally against a corresponding FHIR server container also running locally. Just be sure to generate data using the FHIR mode, not IoT Hub. 

A locally running analysis container will be required to allow vitals to show up on a locally running frontend. Otherwise vitals will not be considered final and the frontend will likely only show a patient with no set vitals.

## Prerequisite Software Needed for Developers

- [Node](https://nodejs.org/en/download/). _Recommended: 12 or higher_
- [docker](https://docs.docker.com/get-docker/)

## TODO: More detailed notes about running analysis container locally

# TODOs

![REMOVE ME](https://freedom1coffee.com/wp-content/uploads/2018/08/remove-before-flight.png)

_**[Remove this section before release]**_

- Update or remove NOTES.txt
- Remove `app.listen` and all the rest in `server.ts`? Its vestigial. 
- can/should the package specific npm installs in dockerfile be handled with a general npm install and those packages be listed in package.json?
- will .env files override env vars being set at build time? _JON: We've determined that env vars generally win out, but clearing .env.production seems to be the proper approach for now._
- there is some inconsistency between how this dockerfile is structured and the subscriber
- remove .env files?? they are handy for a developer, but have values that won't point to anything after release